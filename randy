#!/bin/bash

# =================================================
# FUNGSI UNTUK MELAKUKAN COMMIT
# =================================================
function perform_commit {
  local commit_message=$1
  
  # Muat konfigurasi global (untuk user) dan lokal (untuk DB)
  GLOBAL_CONFIG_FILE="$HOME/.randyconfig"
  LOCAL_CONFIG_FILE=".randy/config"
  if [ -f "$GLOBAL_CONFIG_FILE" ]; then source "$GLOBAL_CONFIG_FILE"; fi
  if [ ! -f "$LOCAL_CONFIG_FILE" ]; then
    echo "‚ùå Konfigurasi database tidak ditemukan. Jalankan 'randy init' dulu."
    return 1
  fi
  source "$LOCAL_CONFIG_FILE"

  # 1. Validasi apakah nama dan email sudah di-set
  if [ -z "$user_name" ] || [ -z "$user_email" ]; then
    echo "‚ùå Error: Identitas Anda belum diatur."
    echo "   Silakan atur nama dan email Anda terlebih dahulu:"
    echo "   randy config user.name \"Nama Anda\""
    echo "   randy config user.email \"email@anda.com\""
    return 1
  fi
  
  echo ""
  echo "üöÄ Memulai commit..."
  
  local TEMP_DIR=$(mktemp -d -p ".randy")
  local SCHEMA_DUMP="$TEMP_DIR/schema.sql"
  local FINAL_HASH_INPUT="$TEMP_DIR/final_hash_input.txt"
  
  # 2. Ambil ID parent commit SEBELUM diubah
  local PARENT_COMMIT_ID=$(cat .randy/refs/heads/main 2>/dev/null)

  # 3. Dump skema
  pg_dump --host="$DB_HOST" --port="$DB_PORT" --username="$DB_USER" --dbname="$DB_NAME" --schema-only -f "$SCHEMA_DUMP"

  # 4. Dapatkan daftar tabel & view, lalu ekspor dan urutkan datanya
  OBJECT_LIST=$(psql --host="$DB_HOST" --port="$DB_PORT" --username="$DB_USER" --dbname="$DB_NAME" -t -A -F'|' -c "SELECT table_type, table_schema || '.' || table_name FROM information_schema.tables WHERE table_schema NOT IN ('pg_catalog', 'information_schema') ORDER BY 2;")
  cat "$SCHEMA_DUMP" > "$FINAL_HASH_INPUT"

  echo "$OBJECT_LIST" | while IFS='|' read -r object_type object_name; do
    if [ -z "$object_name" ]; then continue; fi
    local SORTED_DATA_FILE="$TEMP_DIR/${object_name//\./_}.csv"
    local COPY_COMMAND=""

    if [ "$object_type" == "BASE TABLE" ]; then
      COPY_COMMAND="COPY $object_name TO STDOUT WITH CSV"
    elif [ "$object_type" == "VIEW" ]; then
      COPY_COMMAND="COPY (SELECT * FROM $object_name) TO STDOUT WITH CSV"
    else
      continue
    fi

    psql --host="$DB_HOST" --port="$DB_PORT" --username="$DB_USER" --dbname="$DB_NAME" -c "$COPY_COMMAND" | sort > "$SORTED_DATA_FILE"
    cat "$SORTED_DATA_FILE" >> "$FINAL_HASH_INPUT"
  done < <(echo "$OBJECT_LIST") # Menggunakan process substitution

  # 5. Buat file metadata untuk commit
  local META_FILE="$TEMP_DIR/commit.meta"
  local AUTHOR="$user_name <$user_email>"

  echo "parent: $PARENT_COMMIT_ID" > "$META_FILE"
  echo "date: $(date -u "+%Y-%m-%dT%H:%M:%SZ")" >> "$META_FILE"
  echo "author: $AUTHOR" >> "$META_FILE"
  echo "message: $commit_message" >> "$META_FILE"

  # 6. Tambahkan file metadata ke file gabungan untuk di-hash
  cat "$META_FILE" >> "$FINAL_HASH_INPUT"
  
  # 7. Hitung hash, arsipkan, dan bersihkan
  local COMMIT_ID=$(sha256sum "$FINAL_HASH_INPUT" | awk '{ print $1 }')
  tar -czf ".randy/objects/$COMMIT_ID" -C "$TEMP_DIR" .
  rm -rf "$TEMP_DIR"
  
  # 8. Update referensi HEAD
  echo "$COMMIT_ID" > ".randy/refs/heads/main"
  echo "‚úÖ Mantap! Commit berhasil dibuat dengan ID: ${COMMIT_ID:0:12}"
}

# Perintah utama
case "$1" in
  init)
    if [ -d ".randy" ]; then
      echo "Hehe, folder .randy nya udah ada euy."
      exit 1
    fi

    echo "Bentar, randy butuh info koneksi database..."

    read -p "Host (default: localhost): " DB_HOST
    read -p "Nama database: " DB_NAME
    read -p "Port (default: 5432): " DB_PORT
    read -p "Username: " DB_USER
    read -s -p "Password: " DB_PASS
    echo # Tambah baris baru setelah input password

    # Atur nilai default jika input kosong
    DB_HOST=${DB_HOST:-localhost}
    DB_PORT=${DB_PORT:-5432}

    echo ""
    echo "Oke, randy coba konek dulu ya..."

    # Tes koneksi ke database
    PGPASSWORD="$DB_PASS" psql --host="$DB_HOST" --port="$DB_PORT" --username="$DB_USER" --dbname="$DB_NAME" -c "\q" 2>/dev/null

    if [ $? -ne 0 ]; then
      echo "‚ùå Duh, gagal konek euy. Coba cek lagi info databasenya."
      exit 1
    fi

    echo "‚úÖ Sip, koneksi berhasil!"
    echo ""
    echo "Bentar, randy lagi buat repositorynya yaaaa..."
    mkdir -p .randy/{objects,refs/heads}
    touch .randy/refs/heads/main
    echo "ref: refs/heads/main" > .randy/HEAD

    # Simpan konfigurasi ke file
    CONFIG_FILE=".randy/config"
    echo "export DB_HOST=\"$DB_HOST\"" > "$CONFIG_FILE"
    echo "export DB_NAME=\"$DB_NAME\"" >> "$CONFIG_FILE"
    echo "export DB_PORT=\"$DB_PORT\"" >> "$CONFIG_FILE"
    echo "export DB_USER=\"$DB_USER\"" >> "$CONFIG_FILE"
    echo "export PGPASSWORD=\"$DB_PASS\"" >> "$CONFIG_FILE"

    echo "Oke Udah. Konfigurasi disimpen di $CONFIG_FILE"

    echo ""
    echo "Oke, repositori siap. Kamu bisa atur nama dan email terlebih dahulu:"
    echo "   randy config user.name \"Nama kamu\""
    echo "   randy config user.email \"email@kamu.com\""
    ;;

  status)
    if [ ! -f ".randy/config" ]; then
      echo "Duh, ini bukan repositori randy. Jalanin 'randy init' dulu."
      exit 1
    fi

    source .randy/config

    LATEST_COMMIT_ID=$(cat .randy/refs/heads/main)
    if [ -z "$LATEST_COMMIT_ID" ]; then
      echo "Belum ada commit sama sekali di repositori ini."
      exit 0
    fi

    echo "Saat ini berada di commit: ${LATEST_COMMIT_ID:0:12}"
    echo "Mengecek status database..."

    OLD_DATA_DIR=$(mktemp -d -p ".randy")
    NEW_DATA_DIR=$(mktemp -d -p ".randy")
    
    tar -xzf ".randy/objects/$LATEST_COMMIT_ID" -C "$OLD_DATA_DIR"

    SCHEMA_DUMP_NEW="$NEW_DATA_DIR/schema.sql"
    pg_dump --host="$DB_HOST" --port="$DB_PORT" --username="$DB_USER" --dbname="$DB_NAME" --schema-only -f "$SCHEMA_DUMP_NEW" > /dev/null 2>&1
    OBJECT_LIST=$(psql --host="$DB_HOST" --port="$DB_PORT" --username="$DB_USER" --dbname="$DB_NAME" -t -A -F'|' -c "SELECT table_type, table_schema || '.' || table_name FROM information_schema.tables WHERE table_schema NOT IN ('pg_catalog', 'information_schema') ORDER BY 2;")
    
    HAS_CHANGES=false
    
    while IFS='|' read -r object_type object_name; do
      if [ -z "$object_name" ]; then continue; fi
      
      FILE_NAME="${object_name//\./_}.csv"
      OLD_FILE="$OLD_DATA_DIR/$FILE_NAME"
      NEW_FILE="$NEW_DATA_DIR/$FILE_NAME"
      COPY_COMMAND=""

      if [ "$object_type" == "BASE TABLE" ]; then
        COPY_COMMAND="COPY $object_name TO STDOUT WITH CSV"
      elif [ "$object_type" == "VIEW" ]; then
        COPY_COMMAND="COPY (SELECT * FROM $object_name) TO STDOUT WITH CSV"
      else
        continue
      fi

      psql --host="$DB_HOST" --port="$DB_PORT" --username="$DB_USER" --dbname="$DB_NAME" -c "$COPY_COMMAND" | sort > "$NEW_FILE"

      DIFF_OUTPUT=$(diff "$OLD_FILE" "$NEW_FILE")
      if [ -n "$DIFF_OUTPUT" ]; then
        if ! $HAS_CHANGES; then
            echo "‚ö†Ô∏è  Database telah dimodifikasi. Perubahan terdeteksi:"
            HAS_CHANGES=true
        fi
        echo "--------------------------------------------------"
        echo "Perubahan pada ($object_type): $object_name"
        echo "--------------------------------------------------"
        echo "$DIFF_OUTPUT"
        echo ""
      fi
    done < <(echo "$OBJECT_LIST") 

    rm -rf "$OLD_DATA_DIR" "$NEW_DATA_DIR"

    if ! $HAS_CHANGES; then
        echo "‚úÖ Database bersih, tidak ada perubahan sejak commit terakhir."
    fi
    ;;

  commit)
    # Cek apakah argumen kedua adalah '-m' dan argumen ketiga (pesannya) tidak kosong
    if [ "$2" == "-m" ] && [ -n "$3" ]; then
      # Geser argumen, buang 'randy' dan '-m'
      shift 2 
      # Ambil sisa argumen sebagai satu pesan utuh
      commit_message="$*"
      perform_commit "$commit_message"
    else
      echo "‚ùå Error: pesan commit dibutuhkan."
      echo "   Penggunaan: randy commit -m \"Pesan commit Anda\""
      exit 1
    fi
    ;;

  log)
    if [ ! -f ".randy/refs/heads/main" ]; then
      echo "Duh, ini bukan repositori randy atau belum ada commit."
      exit 1
    fi

    # Ambil commit paling akhir sebagai titik awal
    COMMIT_ID=$(cat .randy/refs/heads/main)

    if [ -z "$COMMIT_ID" ]; then
      echo "Belum ada commit di repositori ini."
      exit 0
    fi

    # Definisi warna untuk output
    COLOR_YELLOW='\033[0;33m'
    COLOR_RESET='\033[0m'

    # Loop mundur mengikuti parent commit
    while [ -n "$COMMIT_ID" ]; do
      COMMIT_OBJECT_FILE=".randy/objects/$COMMIT_ID"
      if [ ! -f "$COMMIT_OBJECT_FILE" ]; then
        echo "‚ùå Error: Objek commit $COMMIT_ID tidak ditemukan."
        break
      fi

      # Ekstrak file metadata dari arsip
      METADATA=$(tar -xzf "$COMMIT_OBJECT_FILE" -O ./commit.meta 2>/dev/null)
      
      if [ -z "$METADATA" ]; then
        echo "‚ùå Error: Gagal membaca metadata dari commit $COMMIT_ID"
        break
      fi

      # Parsing setiap baris dari metadata
      AUTHOR=$(echo "$METADATA" | grep '^author:' | sed 's/author: //')
      DATE=$(echo "$METADATA" | grep '^date:' | sed 's/date: //')
      MESSAGE=$(echo "$METADATA" | grep '^message:' | sed 's/message: //')
      
      # Tampilkan log dengan format mirip 'git log'
      echo -e "${COLOR_YELLOW}commit $COMMIT_ID${COLOR_RESET}"
      echo "Author: $AUTHOR"
      echo "Date:   $DATE"
      echo ""
      echo "    $MESSAGE"
      echo ""

      # Ambil ID parent untuk iterasi selanjutnya
      PARENT_ID=$(echo "$METADATA" | grep '^parent:' | sed 's/parent: //')
      COMMIT_ID="$PARENT_ID"
    done
    ;;
  checkout)
    # Logika untuk 'randy checkout' ada di sini
    echo "Kita pindah duluuu..."
    ;;

  config)
    # File konfigurasi lokal di dalam direktori .randy
    LOCAL_CONFIG_FILE=".randy/config"
    
    # Pastikan repositori sudah di-init dulu
    if [ ! -d ".randy" ]; then
      echo "‚ùå Error: Ini bukan repositori randy. Jalankan 'randy init' dulu."
      exit 1
    fi
    
    # Pastikan format perintah benar
    if [ "$#" -ne 3 ]; then
      echo "‚ùå Error: format perintah salah."
      echo "   Penggunaan: randy config user.name \"Nama Anda\""
      exit 1
    fi
    
    KEY=$2
    VALUE=$3
    SHELL_SAFE_KEY=""

    # Terjemahkan key yang menggunakan titik menjadi garis bawah
    case "$KEY" in
      user.name)
        SHELL_SAFE_KEY="user_name"
        ;;
      user.email)
        SHELL_SAFE_KEY="user_email"
        ;;
      *)
        echo "‚ùå Error: Kunci konfigurasi '$KEY' tidak dikenal."
        exit 1
        ;;
    esac

    # Cek apakah key sudah ada di file config
    if grep -q "^export ${SHELL_SAFE_KEY}=" "$LOCAL_CONFIG_FILE" 2>/dev/null; then
      # Jika ada, ganti nilainya
      sed -i "s|^export ${SHELL_SAFE_KEY}=.*|export ${SHELL_SAFE_KEY}=\"${VALUE}\"|" "$LOCAL_CONFIG_FILE"
    else
      # Jika tidak ada, tambahkan baris baru
      echo "export ${SHELL_SAFE_KEY}=\"${VALUE}\"" >> "$LOCAL_CONFIG_FILE"
    fi
    
    echo "‚úÖ Konfigurasi '$KEY' berhasil disimpan."
    ;;
  *)
    echo "Duh, buat sekarang perintah '$1' belum tersedia euy.."
    echo "Yang bisa di pake: randy {init|commit|checkout|log}"
    exit 1
    ;;
esac